<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web3 Address Recon Results</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üîç</text></svg>">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 20px;
            background-color: #121212;
            color: #e0e0e0;
        }
        h1 {
            text-align: center;
            color: #ffffff;
        }
        p {
            color: #a0a0a0;
        }
        #uploader {
            display: block;
            margin: 20px auto;
            padding: 10px;
            border: 2px dashed #444;
            border-radius: 5px;
            cursor: pointer;
            text-align: center;
            background-color: #1e1e1e;
            color: #e0e0e0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 3px rgba(0,0,0,0.4);
        }
        th, td {
            border: 1px solid #333;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #2a2a2a;
            color: #ffffff;
        }
        tbody tr {
            background-color: #1e1e1e;
        }
        tbody tr:nth-child(even) {
            background-color: #242424;
        }
        .safe-wallet-row {
            background-color: #1c252c !important; /* Subtle dark cyan/grey */
        }
        .safe-wallet-row:nth-child(even) {
            background-color: #222b31 !important; /* Slightly lighter subtle dark cyan/grey */
        }
        #error-message {
            color: #ff5555;
            text-align: center;
            margin-top: 10px;
        }
        .clickable-address {
            cursor: pointer;
            text-decoration: underline;
            color: #64b5f6;
        }
        #detail-view {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background-color: #1e1e1e;
            border: 1px solid #333;
            border-radius: 5px;
        }
        #detail-view h2 {
            margin-top: 0;
        }
        #detail-view h3 {
            margin-top: 25px;
            border-bottom: 1px solid #444;
            padding-bottom: 5px;
        }
        #detail-view p {
            text-align: left;
        }
        #back-button {
            margin-bottom: 20px;
            padding: 10px 15px;
            background-color: #2a2a2a;
            border: none;
            color: white;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <h1>Web3 Address Reconnaissance Results</h1>
    <p style="text-align: center;">Select your <code>web3-address-recon.sqlite3</code> file to view the results.</p>
    <input type="file" id="uploader" />
    <div id="error-message"></div>

    <div id="table-view">
        <table id="results-table">
            <thead>
                <tr>
                    <th>Network</th>
                    <th>Address</th>
                    <th>Native Balance (Wei)</th>
                    <th>Is EOA?</th>
                    <th>Safe Owner Count</th>
                    <th>Safe Threshold</th>
                    <th>Safe Nonce</th>
                    <th>Etherscan</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>

    <div id="detail-view">
        <button id="back-button">&larr; Back to Results</button>
        <h2 id="detail-address"></h2>
        <div id="detail-properties"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/sql-wasm.js"></script>
    <script>
        const uploader = document.getElementById('uploader');
        const errorMessage = document.getElementById('error-message');
        const tableView = document.getElementById('table-view');
        const detailView = document.getElementById('detail-view');
        const backButton = document.getElementById('back-button');

        let db;

        async function loadDatabase(file) {
            const sqlPromise = initSqlJs({
                locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/${file}`
            });

            const dataPromise = file.arrayBuffer();
            const [SQL, buf] = await Promise.all([sqlPromise, dataPromise]);
            return new SQL.Database(new Uint8Array(buf));
        }

        function renderTable() {
            const tableBody = document.querySelector('#results-table tbody');
            tableBody.innerHTML = '';
            const results = db.exec(`
                SELECT
                    a.network,
                    a.address,
                    evm.native_balance,
                    evm.is_eoa,
                    sw.owner_count,
                    sw.threshold,
                    sw.nonce
                FROM addresses a
                LEFT JOIN evm_properties evm ON a.id = evm.address_id
                LEFT JOIN safe_wallets sw ON a.id = sw.address_id
            `);

            if (results.length === 0) {
                    errorMessage.textContent = "No data found. The database might be empty.";
                    return;
            }

            const records = results[0].values;
            records.forEach(record => {
                const row = tableBody.insertRow();
                const isSafe = record[5] !== null;
                if (isSafe) {
                    row.classList.add('safe-wallet-row');
                }

                row.insertCell().textContent = record[0] || 'N/A';

                const addressCell = row.insertCell();
                addressCell.textContent = record[1] || 'N/A';
                addressCell.classList.add('clickable-address');
                addressCell.addEventListener('click', () => showDetail(record[0], record[1]));

                row.insertCell().textContent = record[2] || 'N/A';
                row.insertCell().textContent = record[3] === null ? 'N/A' : (record[3] ? 'Yes' : 'No');
                row.insertCell().textContent = record[4] || 'N/A';
                row.insertCell().textContent = record[5] || 'N/A';
                row.insertCell().textContent = record[6] || 'N/A';

                const etherscanCell = row.insertCell();
                if (record[0] === 'ethereum' && record[1]) {
                    const link = document.createElement('a');
                    link.href = `https://etherscan.io/address/${record[1]}`;
                    link.textContent = "View";
                    link.target = "_blank";
                    etherscanCell.appendChild(link);
                }
            });
        }

        function showDetail(network, address) {
            tableView.style.display = 'none';
            detailView.style.display = 'block';

            document.getElementById('detail-address').textContent = address;
            const propertiesDiv = document.getElementById('detail-properties');
            propertiesDiv.innerHTML = '';

            const idStmt = db.prepare("SELECT id FROM addresses WHERE network = :network AND address = :address");
            idStmt.bind({ ':network': network, ':address': address });
            if (!idStmt.step()) {
                propertiesDiv.textContent = "Could not find address details.";
                idStmt.free();
                return;
            }
            const addressId = idStmt.get()[0];
            idStmt.free();

            const appendProperties = (dataObject) => {
                for (const [key, value] of Object.entries(dataObject)) {
                    if (value !== null && key !== 'address_id') {
                        const p = document.createElement('p');
                        let displayValue = value;
                        if (typeof value === 'boolean' || (key.includes('is_') && (value === 0 || value === 1))) {
                            displayValue = value ? 'Yes' : 'No';
                        }
                        p.innerHTML = `<strong>${key.replace(/_/g, ' ')}:</strong> ${displayValue}`;
                        propertiesDiv.appendChild(p);
                    }
                }
            };

            const mainPropsStmt = db.prepare(`
                SELECT a.source, evm.native_balance, evm.is_eoa, evm.is_safe
                FROM addresses a
                LEFT JOIN evm_properties evm ON a.id = evm.address_id
                WHERE a.id = :address_id
            `);
            mainPropsStmt.bind({ ':address_id': addressId });
            if (mainPropsStmt.step()) {
                appendProperties(mainPropsStmt.getAsObject());
            }
            mainPropsStmt.free();

            const safeStmt = db.prepare("SELECT threshold, nonce, owner_count FROM safe_wallets WHERE address_id = :address_id");
            safeStmt.bind({ ':address_id': addressId });
            if (safeStmt.step()) {
                appendProperties(safeStmt.getAsObject());

                // CORRECTED QUERY: Selects owner_address directly without the erroneous join.
                const ownersStmt = db.prepare(`
                    SELECT owner_address
                    FROM safe_wallet_owners
                    WHERE safe_address_id = :address_id
                `);
                ownersStmt.bind({ ':address_id': addressId });

                const owners = [];
                while(ownersStmt.step()) {
                    owners.push(ownersStmt.get()[0]);
                }
                ownersStmt.free();

                if (owners.length > 0) {
                    const title = document.createElement('h3');
                    title.textContent = "Safe Owners";
                    propertiesDiv.appendChild(title);

                    const ownersTable = document.createElement('table');
                    const thead = ownersTable.createTHead();
                    const headerRow = thead.insertRow();
                    headerRow.insertCell().outerHTML = '<th>Owner Address</th>';
                    headerRow.insertCell().outerHTML = '<th>Etherscan</th>';

                    const tbody = ownersTable.createTBody();
                    owners.forEach(owner => {
                        const row = tbody.insertRow();
                        row.insertCell().textContent = owner;
                        const linkCell = row.insertCell();
                        if (network === 'ethereum' && owner) {
                            const link = document.createElement('a');
                            link.href = `https://etherscan.io/address/${owner}`;
                            link.textContent = "View";
                            link.target = "_blank";
                            linkCell.appendChild(link);
                        }
                    });
                    propertiesDiv.appendChild(ownersTable);
                }
            }
            safeStmt.free();
        }

        uploader.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) {
                return;
            }
            errorMessage.textContent = '';

            try {
                db = await loadDatabase(file);
                renderTable();
            } catch (err) {
                console.error("Error processing database file:", err);
                errorMessage.textContent = "Error: Could not read the database file. Ensure it is a valid SQLite file.";
            }
        });

        backButton.addEventListener('click', () => {
            detailView.style.display = 'none';
            tableView.style.display = 'block';
        });

    </script>
</body>
</html>
