<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web3 Address Recon Dashboard</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23d1d5db' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><circle cx='11' cy='11' r='8'></circle><line x1='21' y1='21' x2='16.65' y2='16.65'></line></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/sql-wasm.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Dark gray background */
        }
        .loader {
            border-top-color: #3b82f6;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @-webkit-keyframes spinner {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .progress-bar-container {
            background-color: #374151; /* gray-700 */
            border-radius: 9999px;
            height: 0.75rem; /* h-3 */
            overflow: hidden;
        }
        .progress-bar {
            border-radius: 9999px;
            height: 100%;
            transition: width 0.5s ease-in-out;
        }
    </style>
</head>
<body class="text-gray-300">

    <div class="container mx-auto p-4 md:p-8">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-white">Web3 Recon Dashboard</h1>
            <p class="text-gray-400 mt-1">Upload your SQLite database to analyze wallet data.</p>
        </header>

        <div class="bg-gray-800 p-6 rounded-lg shadow-lg mb-6">
            <label for="db-upload" class="block text-sm font-medium text-gray-400 mb-2">Database File (.sqlite3)</label>
            <input type="file" id="db-upload" accept=".sqlite, .sqlite3, .db" class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-800 file:text-blue-200 hover:file:bg-blue-700"/>
            <div id="loading-indicator" class="hidden mt-4 flex items-center">
                <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-600 h-6 w-6 mr-3"></div>
                <span class="text-gray-400">Loading and processing database...</span>
            </div>
             <p id="error-message" class="text-red-500 text-sm mt-2 hidden"></p>
        </div>

        <div class="bg-yellow-900 bg-opacity-50 border-l-4 border-yellow-700 text-yellow-300 p-4 rounded-md mb-8" role="alert">
            <p class="font-bold">Assumption</p>
            <p>ETH price is assumed to be <strong>$4,600 USD</strong> for all calculations.</p>
        </div>

        <main id="dashboard-content" class="hidden">
            <section id="key-stats" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 mb-8">
                <div id="total-funds-card" class="bg-gray-800 p-6 rounded-lg shadow-lg cursor-pointer hover:bg-gray-700 transition-colors">
                    <h2 class="text-sm font-medium text-gray-400 uppercase whitespace-nowrap">Total Funds Surveyed</h2>
                    <p id="total-funds" class="text-3xl font-bold mt-2 text-white">$0.00</p>
                    <p id="total-eth" class="text-sm text-gray-400 mt-1">0 ETH</p>
                    <p class="text-sm text-gray-400 mt-1">Click to view all addresses</p>
                </div>

                <div id="breakdown-card" class="bg-gray-800 p-6 rounded-lg shadow-lg cursor-pointer hover:bg-gray-700 transition-colors">
                    <h2 class="text-sm font-medium text-gray-400 uppercase mb-4">Address Breakdown</h2>
                    <div class="space-y-4">
                        <div id="eoa-breakdown">
                            <div class="flex justify-between items-baseline mb-1">
                                <span class="text-sm text-gray-400 font-medium">EOA (<span id="eoa-count">0</span>)</span>
                                <span class="text-sm text-white font-semibold" id="eoa-value">$0 (0.00%)</span>
                            </div>
                            <div class="progress-bar-container">
                                <div id="eoa-bar" class="progress-bar bg-blue-500" style="width: 0%;"></div>
                            </div>
                        </div>
                        <div id="safe-breakdown">
                            <div class="flex justify-between items-baseline mb-1">
                                <span class="text-sm text-gray-400 font-medium">SAFE (<span id="safe-count">0</span>)</span>
                                <span class="text-sm text-white font-semibold" id="safe-value">$0 (0.00%)</span>
                            </div>
                            <div class="progress-bar-container">
                                <div id="safe-bar" class="progress-bar bg-green-500" style="width: 0%;"></div>
                            </div>
                        </div>
                        <div id="sc-breakdown">
                             <div class="flex justify-between items-baseline mb-1">
                                <span class="text-sm text-gray-400 font-medium">Smart Contracts (<span id="sc-count">0</span>)</span>
                                <span class="text-sm text-white font-semibold" id="sc-value">$0 (0.00%)</span>
                            </div>
                            <div class="progress-bar-container">
                                <div id="sc-bar" class="progress-bar bg-yellow-500" style="width: 0%;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="unique-owners-card" class="bg-gray-800 p-6 rounded-lg shadow-lg cursor-pointer hover:bg-gray-700 transition-colors hidden">
                    <h2 class="text-sm font-medium text-gray-400 uppercase whitespace-nowrap">Total Safe Wallet Unique Owners</h2>
                    <p id="unique-owners-count" class="text-3xl font-bold mt-2 text-white">0</p>
                    <p class="text-sm text-gray-400 mt-1">Click to view details</p>
                </div>
            </section>

            <section id="owner-portfolios" class="bg-gray-800 p-6 rounded-lg shadow-lg mb-8 hidden">
                <h2 class="text-xl font-bold text-white mb-4">Safe Wallet Owner Portfolios</h2>
                <p class="text-gray-400 mb-6">Unique owners and the cumulative value of the SAFE wallets they control.</p>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-700">
                        <thead class="bg-gray-700">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Owner Address</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Controlled SAFE Wallets</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Total Controlled Value (USD)</th>
                            </tr>
                        </thead>
                        <tbody id="owner-table-body" class="bg-gray-800 divide-y divide-gray-700"></tbody>
                    </table>
                </div>
            </section>

            <section id="all-addresses-section" class="bg-gray-800 p-6 rounded-lg shadow-lg mb-8 hidden">
                <h2 id="addresses-title" class="text-xl font-bold text-white mb-4">All Surveyed Addresses</h2>
                <p id="addresses-description" class="text-gray-400 mb-6">A complete list of all addresses found in the database, sorted by balance.</p>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-700">
                        <thead id="addresses-thead" class="bg-gray-700"></thead>
                        <tbody id="all-addresses-table-body" class="bg-gray-800 divide-y divide-gray-700"></tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <script type="module">
        const ETH_PRICE_USD = 4600;
        const WEI_PER_ETH = 10n ** 18n;

        const fileInput = document.getElementById('db-upload');
        const loadingIndicator = document.getElementById('loading-indicator');
        const dashboardContent = document.getElementById('dashboard-content');
        const errorMessage = document.getElementById('error-message');

        const totalFundsCard = document.getElementById('total-funds-card');
        const breakdownCard = document.getElementById('breakdown-card');
        const eoaBreakdown = document.getElementById('eoa-breakdown');
        const safeBreakdown = document.getElementById('safe-breakdown');
        const scBreakdown = document.getElementById('sc-breakdown');
        const uniqueOwnersCard = document.getElementById('unique-owners-card');

        const ownerPortfoliosSection = document.getElementById('owner-portfolios');
        const allAddressesSection = document.getElementById('all-addresses-section');
        const addressesTitle = document.getElementById('addresses-title');
        const addressesDescription = document.getElementById('addresses-description');
        const addressesThead = document.getElementById('addresses-thead');
        const allAddressesTableBody = document.getElementById('all-addresses-table-body');

        const formatCurrency = (value) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(value);
        const formatNumber = (value) => new Intl.NumberFormat('en-US').format(value);

        const formatCompactCurrency = (value) => {
            if (value >= 1e9) return `$${(value / 1e9).toFixed(1)}B`;
            if (value >= 1e6) return `$${(value / 1e6).toFixed(1)}M`;
            if (value >= 1e3) return `$${(value / 1e3).toFixed(1)}K`;
            return formatCurrency(value);
        };

        const weiToEth = (weiString) => {
            if (!weiString) return 0;
            try {
                const weiBigInt = BigInt(weiString);
                const ethValue = Number(weiBigInt * 1000000n / WEI_PER_ETH) / 1000000;
                return ethValue;
            } catch (e) {
                console.error(`Could not convert wei string to BigInt: ${weiString}`, e);
                return 0;
            }
        };

        const initSqlJs = async () => {
            try {
                const sql = await window.initSqlJs({ locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/${file}` });
                return sql;
            } catch (err) {
                console.error("Failed to initialize sql.js:", err);
                showError("Failed to load the SQL library. Please check your internet connection and try again.");
                return null;
            }
        };

        const showError = (message) => {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
            loadingIndicator.classList.add('hidden');
        };

        const hideError = () => errorMessage.classList.add('hidden');

        let allAddresses = [];
        let currentFilter = 'all';

        const setFilter = (filter) => {
            currentFilter = filter;
            uniqueOwnersCard.classList.toggle('hidden', filter !== 'safe');
            populateAddressesTable(filter);
            allAddressesSection.classList.remove('hidden');
            ownerPortfoliosSection.classList.add('hidden');
        };

        totalFundsCard.addEventListener('click', () => setFilter('all'));

        breakdownCard.addEventListener('click', () => setFilter('all'));

        eoaBreakdown.addEventListener('click', (e) => {
            e.stopPropagation();
            setFilter('eoa');
        });

        safeBreakdown.addEventListener('click', (e) => {
            e.stopPropagation();
            setFilter('safe');
        });

        scBreakdown.addEventListener('click', (e) => {
            e.stopPropagation();
            setFilter('sc');
        });

        uniqueOwnersCard.addEventListener('click', () => {
            allAddressesSection.classList.add('hidden');
            ownerPortfoliosSection.classList.remove('hidden');
        });

        fileInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            hideError();
            loadingIndicator.classList.remove('hidden');
            dashboardContent.classList.add('hidden');
            ownerPortfoliosSection.classList.add('hidden');
            allAddressesSection.classList.add('hidden');

            const SQL = await initSqlJs();
            if (!SQL) return;

            const fileBuffer = await file.arrayBuffer();

            try {
                const db = new SQL.Database(new Uint8Array(fileBuffer));
                runAnalysis(db);
                dashboardContent.classList.remove('hidden');
            } catch (err) {
                console.error("Error processing database file:", err);
                showError("The file provided does not appear to be a valid SQLite database.");
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        });

        function populateAddressesTable(filter) {
            let filteredAddresses = allAddresses;

            if (filter === 'eoa') {
                filteredAddresses = allAddresses.filter(data => data.isEoa && !data.isSafe);
            } else if (filter === 'safe') {
                filteredAddresses = allAddresses.filter(data => data.isSafe);
            } else if (filter === 'sc') {
                filteredAddresses = allAddresses.filter(data => !data.isEoa && !data.isSafe);
            }

            filteredAddresses.sort((a, b) => {
                if (b.balanceWei > a.balanceWei) return 1;
                if (b.balanceWei < a.balanceWei) return -1;
                return 0;
            });

            // Update title and description
            if (filter === 'all') {
                addressesTitle.textContent = 'All Surveyed Addresses';
                addressesDescription.textContent = 'A complete list of all addresses found in the database, sorted by balance.';
            } else if (filter === 'eoa') {
                addressesTitle.textContent = 'Surveyed Externally Owned Addresses (EOAs)';
                addressesDescription.textContent = 'A list of EOAs found in the database, sorted by balance.';
            } else if (filter === 'safe') {
                addressesTitle.textContent = 'Surveyed Safe Wallets';
                addressesDescription.textContent = 'A list of Safe Wallets found in the database, sorted by balance.';
            } else if (filter === 'sc') {
                addressesTitle.textContent = 'Surveyed Smart Contracts (Not Safe Wallets)';
                addressesDescription.textContent = 'A list of Smart Contracts (Not Safe Wallets) found in the database, sorted by balance.';
            }

            // Build thead
            let theadHtml = `
                <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Address</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Native Balance (ETH)</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Market Value (USD)</th>
            `;
            if (filter === 'all') {
                theadHtml += `<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Address Type</th>`;
            } else if (filter === 'safe') {
                theadHtml += `<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Threshold / Owners</th>`;
            }
            theadHtml += `</tr>`;
            addressesThead.innerHTML = theadHtml;

            // Build tbody
            allAddressesTableBody.innerHTML = '';
            filteredAddresses.forEach(data => {
                const ethValue = weiToEth(data.balanceWei.toString());
                const usdValue = ethValue * ETH_PRICE_USD;
                let rowHtml = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400 font-mono">
                        <a href="https://etherscan.io/address/${data.address}" target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:underline">${data.address}</a>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-white">${ethValue.toFixed(3)} ETH</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-white font-semibold">${formatCurrency(usdValue)}</td>
                `;
                if (filter === 'all') {
                    const addressType = data.isSafe ? 'SAFE Wallet' : (data.isEoa ? 'EOA' : 'Smart Contract');
                    rowHtml += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">${addressType}</td>`;
                } else if (filter === 'safe') {
                    const thresholdOwner = `${data.threshold ?? 'N/A'} / ${data.ownerCount ?? 'N/A'}`;
                    rowHtml += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">${thresholdOwner}</td>`;
                }
                const row = document.createElement('tr');
                row.innerHTML = rowHtml;
                allAddressesTableBody.appendChild(row);
            });
        }

        function runAnalysis(db) {
            // 1. Calculate Total Funds
            const totalFundsQuery = "SELECT SUM(CAST(native_balance AS REAL)) FROM evm_properties";
            const totalFundsResult = db.exec(totalFundsQuery);
            const totalFundsWei = BigInt(totalFundsResult[0]?.values[0]?.[0] || '0');
            const totalEth = weiToEth(totalFundsWei.toString());
            const totalFundsUsd = totalEth * ETH_PRICE_USD;
            document.getElementById('total-funds').textContent = formatCurrency(totalFundsUsd);
            document.getElementById('total-eth').textContent = `${totalEth.toFixed(4)} ETH`;

            // 2. Process All Addresses for Breakdown and Detailed Table
            const allAddressesQuery = `
                SELECT a.address, ep.native_balance, ep.is_safe, ep.is_eoa, sw.threshold, sw.owner_count
                FROM evm_properties ep
                JOIN addresses a ON ep.address_id = a.id
                LEFT JOIN safe_wallets sw ON ep.address_id = sw.address_id;
            `;
            const allAddressesResult = db.exec(allAddressesQuery);
            allAddresses = [];

            const breakdown = {
                eoa: { count: 0, totalWei: 0n },
                safe: { count: 0, totalWei: 0n },
                sc: { count: 0, totalWei: 0n },
            };

            if (allAddressesResult.length > 0) {
                allAddressesResult[0].values.forEach(([address, balance, isSafe, isEoa, threshold, ownerCount]) => {
                    const balanceWei = BigInt(balance || '0');
                    allAddresses.push({ address, balanceWei, isSafe, isEoa, threshold, ownerCount });

                    if (isSafe) {
                        breakdown.safe.count++;
                        breakdown.safe.totalWei += balanceWei;
                    } else if (isEoa) {
                        breakdown.eoa.count++;
                        breakdown.eoa.totalWei += balanceWei;
                    } else {
                        breakdown.sc.count++;
                        breakdown.sc.totalWei += balanceWei;
                    }
                });
            }

            // 3. Populate Address Breakdown Card
            const populateBreakdown = (type, data) => {
                const eth = weiToEth(data.totalWei.toString());
                const usd = eth * ETH_PRICE_USD;
                const percentage = totalFundsUsd > 0 ? (usd / totalFundsUsd) * 100 : 0;

                document.getElementById(`${type}-count`).textContent = formatNumber(data.count);
                document.getElementById(`${type}-value`).textContent = `${formatCompactCurrency(usd)} (${percentage.toFixed(2)}%)`;
                document.getElementById(`${type}-bar`).style.width = `${percentage}%`;
            };

            populateBreakdown('eoa', breakdown.eoa);
            populateBreakdown('safe', breakdown.safe);
            populateBreakdown('sc', breakdown.sc);

            // 4. Populate All Surveyed Addresses Table (initially with 'all')
            populateAddressesTable('all');

            // 5. Process and Populate Owner Portfolios
            const ownerPortfolioQuery = `
                SELECT swo.owner_address, a.address as safe_address, ep.native_balance
                FROM safe_wallet_owners swo
                JOIN addresses a ON swo.safe_address_id = a.id
                JOIN evm_properties ep ON a.id = ep.address_id
                WHERE ep.is_safe = 1;
            `;
            const ownerResults = db.exec(ownerPortfolioQuery);
            const ownerPortfolios = {};

            if (ownerResults.length > 0) {
                ownerResults[0].values.forEach(([owner, safe, balance]) => {
                    if (!ownerPortfolios[owner]) {
                        ownerPortfolios[owner] = { safes: new Set(), totalWei: 0n };
                    }
                    ownerPortfolios[owner].safes.add(safe);
                    ownerPortfolios[owner].totalWei += BigInt(balance || '0');
                });
            }

            const ownerTableBody = document.getElementById('owner-table-body');
            ownerTableBody.innerHTML = '';
            const sortedOwners = Object.entries(ownerPortfolios).sort(([, a], [, b]) => {
                if (b.totalWei > a.totalWei) return 1;
                if (b.totalWei < a.totalWei) return -1;
                return 0;
            });

            document.getElementById('unique-owners-count').textContent = formatNumber(sortedOwners.length);

            sortedOwners.forEach(([owner, data]) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400 font-mono">
                        <a href="https://etherscan.io/address/${owner}" target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:underline">${owner}</a>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">${data.safes.size}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-white font-semibold">${formatCurrency(weiToEth(data.totalWei.toString()) * ETH_PRICE_USD)}</td>
                `;
                ownerTableBody.appendChild(row);
            });
        }
    </script>
</body>
</html>
